function Path(t){if(t&&t.constructor==Path)return t;if(this.constructor!=Path)return new Path(t);var e,n;null==t||void 0==t?t="/":Array.isArray(t)?t=t.join("/"):t+="",n=t.split("/").filter(function(t){return"string"==typeof t&&t.length>0}),e=0==n.length?"/":"/"+n.join("/")+"/",this.string=e,this.array=n,this.length=n.length}function Horten(t){t&&"object"==typeof t||(t={}),t.debug&&(this.debug=!0),this.data={},this.meta={},Horten.__instance||(Horten.__instance=this)}function Listener(t,e){"string"==typeof t&&(t={path:t}),"object"==typeof t&&null!=t&&(this.path=new Path(t.path),this.prefix=new Path(t.prefix),this.primitive=!!t.primitive,this.horten=Horten.instance(),this.onData=e,t.attach!==!1&&this.attach())}function HortenWebSocket(t){null!=t&&(this.primitive=t.primitive=!0,this.FILL_DATA={},this.keepAlive=t&&!!t.keepAlive,Listener.call(this,t,this.onData),this.catchAll=!0,this.attach())}function HortenWebSocketClient(t,e){var n=this;HortenWebSocket.call(this,e),n.name=t;var o;if("function"==typeof WebSocket)this.reconnect=function(){o=new WebSocket(t,"horten-protocol"),this.attachWebSocket(o)};else{if("function"!=typeof WebSocketClient)throw Error("No WebSocket library");this.reconnect=function(){o=new WebSocketClient,o.connect(t,"horten-protocol"),this.attachWebSocketNodeClient(o)}}this.attach(),this.reconnect()}function HortenSockJSClient(t,e,n){var o=this;HortenWebSocket.call(this,n),e=Horten.pathString(e),o.name=t+"/"+e,this.reconnect=function(){var n=new SockJS(t);n.onopen=function(){n.send(JSON.stringify({path:e}))},n.onmessage=function(t){try{t=JSON.parse(t.data)}catch(i){return console.log(o.name,"Bad JSON in server path response",t),n.close(),o.onremoteclose(),void 0}t.path==e?(o.attachWebSocket(n),console.log(o.name,"Connected SockJS"),o.onRemoteData(t)):(console.log(o.name,"Didn't get path handshake from server"),n.close(),o.onremoteclose())},n.onclose=function(){console.log(o.name,"Didn't get path handshake from server"),o.onremoteclose()}},this.reconnect(),this.attach()}Horten.Path=Path,Path.prototype.getSegment=function(t){return this.array[t]},Path.prototype.translate=function(t,e){t=Path(t);var n=t.string.length;return this.string.substr(0,n)!=t.string?void 0:(e=Path(e),t.string==e.string?this:Path(e.string+this.string.substr(n)))},Path.prototype.startsWith=function(t){t=Path(t);var e=t.string.length;return this.string.substr(0,e)!=t.string?!1:Path(this.string.substr(e))},Path.prototype.toString=function(){return this.string};var nextTick;if(nextTick=process&&process.nextTick?process.nextTick:function(t){setTimeout(t,0)},Horten.Horten=Horten,Horten.instance=function(){return Horten.__instance||(Horten.__instance=new Horten),Horten.__instance},Horten.prototype.get=function(t,e){t=Path(t);for(var n=this.data,o=t.array,i=o.length,r=0;i>r&&null!=n;r++)n=n[o[r]];return e||(n=Horten.clone(n)),n},Horten.get=function(t,e){return Horten.instance().get(t,e)},Horten.setFlags={keepTopology:2,forceListeners:4,replace:8},Horten.prototype.set=function(t,e,n,o){function i(t,e,o,i,s){var h,c,l=!1,p=t;if(Array.isArray(t))for(p={},c=0;t.length>c;c++)void 0!==t[c]&&(p[c+""]=!0);if(n&Horten.setFlags.replace)for(h in e)h in p||(a(s,i+h+"/",void 0,!0),delete e[h]);for(h in p)void 0===e[h]&&n&Horten.setFlags.keepTopology||(l=r(h,t[h],e,o&&o._&&o._[h],i+h+"/",s)||l);return l}function r(t,e,r,h,c,p){var u=!1,f=r[t],g=null!=f&&"object"==typeof f,d=null!=e&&"object"==typeof e;return d||f!==e||n&Horten.setFlags.forceListeners?(g!=d||void 0===f)&&n&Horten.setFlags.keepTopology?!1:(h&&h.lp&&(p=p.concat(h.lp)),d?(g||(r[t]=f={}),u=i(e,f,h,c,p)||u):(g&&a(p,c,void 0,!0),r[t]=e,u=!0,l.debug&&console.log(o?o.name:"<anon>",c,e),a(p,c,e)),u&&h&&h.lo&&s(h.lo),u):!1}function s(t){for(var e=0;t.length>e;e++){var n=t[e];n!==o&&(n._objectChange={origin:o,method:"set"},l._pendingListeners||(l._pendingListeners=[]),-1==l._pendingListeners.indexOf(n)&&l._pendingListeners.push(n))}}function a(t,e,n,i){for(var r=0;t.length>r;r++){var s=t[r];if(s!==o){s._primitiveChanges||(s._primitiveChanges={});var a={};a=s._primitiveChanges[e]?s._primitiveChanges[e]:s._primitiveChanges[e]={},a.origin=o,i?a.deleted=!0:a.value=n,l._pendingListeners||(l._pendingListeners=[]),-1==l._pendingListeners.indexOf(s)&&l._pendingListeners.push(s)}}}e=Path(e),n=parseInt(n);var h,c,l=this,p=!1,u=this.data,f=this.meta,g=[],d=[],v=e.length;if("object"!=typeof t&&0==v)return!1;for(c=0;v-1>c;c++){h=e.getSegment(c);var y=u[h];if(null==y||"object"!=typeof y){if(n&Horten.setFlags.keepTopology)return!1;u=u[h]={},p=!0}else u=y;f&&(f.lp&&(g=g.concat(f.lp)),f.lo&&(d=d.concat(f.lo)),f=f._?f._[h]:null)}return f&&(f.lp&&(g=g.concat(f.lp)),f.lo&&(d=d.concat(f.lo))),0==v?p=i(t,u,f,"/",g)||p:(h=e.getSegment(c),f=f&&f._&&f._[h],p=r(h,t,u,f,""+e,g)||p),p&&(s(d),nextTick(function(){l.flush()})),p},Horten.set=function(t,e,n,o){return Horten.instance().set(t,e,n,o)},Horten.prototype.getMeta=function(t,e){t=Path(t);for(var n,o=this.meta,i=0;n=t.getSegment(i);){if(!o._){if(!e)return void 0;o._={}}o._[n]||(o._[n]={}),o=o._[n],i++}return o},Horten.prototype.attachListener=function(t){t.horten&&t.horten!=this?t.horten.removeListener(t):this.removeListener(t);var e=Path(t.path);t._attachedToPath=e,t.horten=this;var n=this.getMeta(e,!0),o=t.primitive?"lp":"lo";void 0==n[o]?n[o]=[t]:n[o].push(t)},Horten.prototype.removeListener=function(t){function e(e){if(o[e]){var n=o[e].indexOf(t);-1!=n&&o[e].splice(n,1),0==o[e].length&&delete o[e]}}if(t.horten&&t.horten!=this)throw"Trying to remove listener attached to different Horten instance";if(t._attachedToPath){var n=Path(t._attachedToPath),o=this.getMeta(n,!1);o&&(e("lp"),e("lo")),delete t._attachedToPath}this._pendingListeners&&(this._pendingListeners=this._pendingListeners.filter(function(e){return e!=t}))},Horten.prototype.flush=function(){var t=this,e=this._pendingListeners;if(e&&e.length)for(var n=0;e.length>n;n++){var o=e[n],i=o._primitiveChanges,r=o._objectChange,s=o.onData,a=Path(o.path),h=Path(o.prefix);if(delete o._primitiveChanges,delete o._objectChange,"function"==typeof s){if(i)for(var c in i){var l=i[c],p=Path(c).translate(a,h);l.deleted?(s.call(o,void 0,p,"delete",l.origin),void 0!==l.value&&s.call(o,l.value,p,"set",l.origin)):s.call(o,l.value,p,"set",l.origin)}r&&s.call(o,t.get(a),h,r.method,r.origin)}}delete this._pendingListeners},Horten.merge=function(t,e,n,o){function i(t,e){var n,i,s=t;if(Array.isArray(t))for(s={},i=0;t.length>i;i++)void 0!==t[i]&&(s[i+""]=!0);if(o&Horten.setFlags.replace)for(n in e)n in s||delete e[n];for(n in s)void 0===e[n]&&o&Horten.setFlags.keepTopology||r(n,t[n],e)}function r(t,e,n){var r=n[t],s=null!=r&&"object"==typeof r,a=null!=e&&"object"==typeof e;return a||r!==e?(s!=a||void 0===r)&&o&Horten.setFlags.keepTopology?!1:(a?(s||(n[t]=r={}),i(e,r)):n[t]=e,void 0):!1}n=Path(n);var s,a,h=t,c=n.length;if("object"!=typeof t){if("/"==n)return e;typeof t!=typeof e&&(h=t={})}for(a=0;c-1>a;a++)if(s=n.getSegment(a),null==h[s]||"object"!=typeof h[s]){if(o&Horten.setFlags.keepTopology)return t;h=h[s]={}}else h=h[s];return 0==c?i(e,h,"/"):(s=n.getSegment(a),r(s,e,h,""+n)),t},Horten.walkObject=function(t,e,n){e=Path(e);var o=e.array,i=o.length;if(null==t)return void 0;for(var r=0;i>r&&null!=t;r++)t=t[o[r]];return n||(t=Horten.clone(t)),t},Horten.clone=function(t){function e(t){var n,o,i={};for(var n in t)o=t[n],i[n]=null!==o&&"object"==typeof o?e(o):o;return i}return"object"==typeof t?e(t):t},Horten.flatten=function(t,e){function n(t,e){switch(typeof t){case"function":case"undefined":return;case"number":case"string":case"boolean":return o[e]=t,void 0}if(null===t)return o[e]=null,void 0;if(Array.isArray(t))for(var i=0;t.length>i;i++){var r=t[i];r!==void 0&&n(r,e+(i+"")+"/")}else for(var s in t)n(t[s],e+s+"/")}e=Path(e);var o={};return n(t,e.string),o},Horten.Listener=Listener,Listener.prototype.attach=function(t){t&&(this.horten=t),this.horten&&this.horten.attachListener(this)},Listener.prototype.remove=function(){this.horten&&this.horten.removeListener(this)},Listener.prototype.push=function(){if(this.primitive){var t,e=this.horten.get(this.path,!0);e=Horten.flatten(e);for(t in e)this.onData(e[t],Path(t).translate(null,this.prefix))}else this.onData(this.horten.get(this.path),Path(this.prefix),"push",this)},Listener.prototype.get=function(t){return(void 0==t||null==t)&&(t=this.prefix),t=Path(t).translate(this.prefix,this.path),t?this.horten.get(t):void 0},Listener.prototype.set=function(t,e,n){return(void 0==e||null==e)&&(e=this.prefix),e=Path(e).translate(this.prefix,this.path),e?this.horten.set(t,e,n,this):null},Listener.prototype.localToGlobalPath=function(t){return Path(t).translate(this.prefix,this.path)},Listener.prototype.globalToLocalPath=function(t){return Path(t).translate(this.path,this.prefix)},Listener.prototype.onData=function(t,e,n,o){"function"==typeof this.callback&&this.callback(t,e,n,o)},"function"==typeof require&&"object"==typeof exports){var WebSocket=require("websocket"),WebSocketClient=WebSocket.client;exports.jsFile=__filename}Horten.WebSocket=HortenWebSocket,HortenWebSocket.prototype=new Listener(null),HortenWebSocket.connect=function(t){return"function"==typeof WebSocket&&t.WebSocket?new HortenWebSocketClient(t.WebSocket):"function"==typeof SockJS&&t.SockJS?new HortenSockJSClient(t.SockJS,t.path):(console.log("Nothing to connect with",SockJS),void 0)},HortenWebSocket.prototype.pull=function(t){t=Horten.pathString(t),this._pullPaths||(this._pullPaths=[]),-1==this._pullPaths.indexOf(t)&&this._pullPaths.push(t),this._pull()},HortenWebSocket.prototype._pull=function(){if(this._pullPaths&&this._pullPaths.length&&this.readyToSend()){var t={get:this._pullPaths};this.send(t)&&(this._pullPaths=null)}},HortenWebSocket.prototype.push=function(t){t=Path(t),this._pushData||(this._pushData={}),this._pushData[t]=this.FILL_DATA,this._push()},HortenWebSocket.prototype.readyToSend=function(){return!1},HortenWebSocket.prototype.onremoteclose=function(){var t=this;this.keepAlive&&"function"==typeof this.reconnect?(console.log(t.name,"Remote closed, retrying in 1 second"),setTimeout(function(){t.reconnect()},1e3)):(console.log(t.name,"Closed by remote"),this.close())},HortenWebSocket.prototype.onData=function(t,e){this._pushData||(this._pushData={}),this._pushData[t]=e,this._push()},HortenWebSocket.prototype.onRemoteData=function(t){if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return console.log(this.name,"Bad JSON from remote"),void 0}if(t.set){var n={};for(var o in t.set){var i=t.set[o],r=this.localToGlobalPath(o);Horten.flattenObject(i,r,n)}console.log("GOT MESG set",n),this.horten.setMultiple(n,this)}t.get&&this.push(t.get)},HortenWebSocket.prototype.close=function(){this.remove(),this.keepAlive=!1,"function"==typeof this._close&&this._close()},HortenWebSocket.prototype._push=function(){if(this._pushData&&this.readyToSend()){var t=!1;for(var e in this._pushData)if(t=!0,this._pushData[e]==this.FILL_DATA){var n=this.localToGlobalPath(e);this._pushData[e]=this.horten.get(n)}t&&this.send({set:this._pushData}),this._pushData={}}},HortenWebSocket.prototype.attachWebSocket=function(t){var e=this;t.onopen=function(){console.log(e.name,"Open WS"),e._push(),e._pull()},t.onerror=function(t){console.log(e.name,"WS error "+JSON.stringify(t))},t.onmessage=function(t){e.onRemoteData(t.data)},t.onclose=function(){console.log(e.name,"onclose"),e.onremoteclose()},this.readyToSend=function(){return 1==t.readyState},this.send=function(e){return 1!=t.readyState?!1:(e=JSON.stringify(e),t.send(e),!0)},this._close=function(){t.close()},1==t.readyState&&(e._push(),e._pull())},HortenWebSocket.prototype.attachWebSocketNodeClient=function(t){var e=this;t.on("connectFailed",function(){console.log(e.name,"Connecting failed"),e.onremoteclose()}),t.on("connect",function(t){console.log(e.name,"Connected "),e.wsn=t,t.on("close",function(){e.onremoteclose()}),t.on("message",function(t){return"utf8"!=t.type?(console.log(e.name,"Not UTF8 from remote"),void 0):(e.onRemoteData(t.utf8Data),void 0)}),e._push(),e._pull()}),this.readyToSend=function(){return e.wsn&&e.wsn.connected},this.send=function(t){return e.wsn&&e.wsn.connected?(e.wsn.sendUTF(JSON.stringify(t)),!0):!1}},HortenWebSocketClient.prototype=new HortenWebSocket(null),HortenSockJSClient.prototype=new HortenWebSocket(null);