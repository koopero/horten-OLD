H=Horten=function(){function t(e){if(e&&e.constructor==t)return e;if(this.constructor!=t)return new t(e);var n,o;null==e||void 0==e?e="/":Array.isArray(e)?e=e.join("/"):e+="",o=e.split("/").filter(function(t){return"string"==typeof t&&t.length>0}),n=0==o.length?"/":"/"+o.join("/")+"/",this.string=n,this.array=o,this.length=o.length}function e(t){t&&"object"==typeof t||(t={}),t.debug&&(this.debug=!0),this.data={},this.meta={},e.__instance||(e.__instance=this)}function n(n,o){"string"==typeof n&&(n={path:n}),"object"==typeof n&&null!=n&&(this.path=new t(n.path),this.prefix=new t(n.prefix),this.primitive=!!n.primitive,this.horten=n.horten||e.instance(),"function"==typeof o&&(this.onData=o),n.attach!==!1&&this.attach())}function o(t){n.call(this,t),this.primitive=!0,this.FILL_DATA={},t&&(this.keepAlive=t&&!!t.keepAlive,this.attach())}function i(t,e){var n=this;o.call(this,e),n.name=t;var i;if("function"==typeof WebSocket)this.reconnect=function(){i=new WebSocket(t,"horten-protocol"),this.attachWebSocket(i)};else{if("function"!=typeof a)throw Error("No WebSocket library");this.reconnect=function(){i=new a,i.connect(t,"horten-protocol"),this.attachWebSocketNodeClient(i)}}this.primitive=!0,this.attach(),this.reconnect()}function r(e,n,i){var r=this;o.call(this,i),n=t(n).string,r.name=e+"/"+n,this.reconnect=function(){var t=new SockJS(e);t.onopen=function(){t.send(JSON.stringify({path:n}))},t.onmessage=function(e){try{e=JSON.parse(e.data)}catch(o){return console.log(r.name,"Bad JSON in server path response",e),t.close(),r.onremoteclose(),void 0}e.path==n?(r.attachWebSocket(t),console.log(r.name,"Connected SockJS"),r.onRemoteData(e)):(console.log(r.name,"Didn't get path handshake from server"),t.close(),r.onremoteclose())},t.onclose=function(){console.log(r.name,"Didn't get path handshake from server"),r.onremoteclose()}},this.reconnect(),this.attach()}e.Path=t,t.prototype.getSegment=function(t){return this.array[t]},t.prototype.translate=function(e,n){e=t(e);var o=e.string.length;return this.string.substr(0,o)!=e.string?void 0:(n=t(n),e.string==n.string?this:t(n.string+this.string.substr(o)))},t.prototype.startsWith=function(e){e=t(e);var n=e.string.length;return this.string.substr(0,n)!=e.string?!1:t(this.string.substr(n))},t.prototype.toString=function(){return this.string};var s;if(s="object"==typeof process&&process.nextTick?process.nextTick:function(t){setTimeout(t,0)},e.Horten=e,e.instance=function(){return e.__instance||(e.__instance=new e),e.__instance},e.prototype.get=function(n,o){n=t(n);for(var i=this.data,r=n.array,s=r.length,a=0;s>a&&null!=i;a++)i=i[r[a]];return o||(i=e.clone(i)),i},e.get=function(t,n){return e.instance().get(t,n)},e.setFlags={keepTopology:2,forceListeners:4,replace:8},e.prototype.set=function(n,o,i,r){function a(t,n,o,r,s){var a,c,p=!1,u=t;if(Array.isArray(t))for(u={},c=0;t.length>c;c++)void 0!==t[c]&&(u[c+""]=!0);if(i&e.setFlags.replace)for(a in n)a in u||(l(s,r+a+"/",void 0,!0),delete n[a]);for(a in u)void 0===n[a]&&i&e.setFlags.keepTopology||(p=h(a,t[a],n,o&&o._&&o._[a],r+a+"/",s)||p);return p}function h(t,n,o,s,h,p){var u=!1,g=o[t],d=null!=g&&"object"==typeof g,v=null!=n&&"object"==typeof n;return v||g!==n||i&e.setFlags.forceListeners?(d!=v||void 0===g)&&i&e.setFlags.keepTopology?!1:(s&&s.lp&&(p=p.concat(s.lp)),v?(d||(o[t]=g={}),u=a(n,g,s,h,p)||u):(d&&l(p,h,void 0,!0),o[t]=n,u=!0,f.debug&&console.log(r?r.name:"<anon>",h,n),l(p,h,n)),u&&s&&s.lo&&c(s.lo),u):!1}function c(t){for(var e=0;t.length>e;e++){var n=t[e];n!==r&&(n._objectChange={origin:r,method:"set"},f._pendingListeners||(f._pendingListeners=[]),-1==f._pendingListeners.indexOf(n)&&f._pendingListeners.push(n))}}function l(t,e,n,o){for(var i=0;t.length>i;i++){var s=t[i];if(s!==r){s._primitiveChanges||(s._primitiveChanges={});var a={};a=s._primitiveChanges[e]?s._primitiveChanges[e]:s._primitiveChanges[e]={},a.origin=r,o?a.deleted=!0:a.value=n,f._pendingListeners||(f._pendingListeners=[]),-1==f._pendingListeners.indexOf(s)&&f._pendingListeners.push(s)}}}o=t(o),i=parseInt(i);var p,u,f=this,g=!1,d=this.data,v=this.meta,y=[],_=[],m=o.length;if("object"!=typeof n&&0==m)return!1;for(u=0;m-1>u;u++){p=o.getSegment(u);var S=d[p];if(null==S||"object"!=typeof S){if(i&e.setFlags.keepTopology)return!1;d=d[p]={},g=!0}else d=S;v&&(v.lp&&(y=y.concat(v.lp)),v.lo&&(_=_.concat(v.lo)),v=v._?v._[p]:null)}return v&&(v.lp&&(y=y.concat(v.lp)),v.lo&&(_=_.concat(v.lo))),0==m?g=a(n,d,v,"/",y)||g:(p=o.getSegment(u),v=v&&v._&&v._[p],g=h(p,n,d,v,""+o,y)||g),g&&(c(_),s(function(){f.flush()})),g},e.set=function(t,n,o,i){return e.instance().set(t,n,o,i)},e.prototype.getMeta=function(e,n){e=t(e);for(var o,i=this.meta,r=0;o=e.getSegment(r);){if(!i._){if(!n)return void 0;i._={}}i._[o]||(i._[o]={}),i=i._[o],r++}return i},e.prototype.attachListener=function(e){e.horten&&e.horten!=this?e.horten.removeListener(e):this.removeListener(e);var n=t(e.path);e._attachedToPath=n,e.horten=this;var o=this.getMeta(n,!0),i=e.primitive?"lp":"lo";void 0==o[i]?o[i]=[e]:o[i].push(e)},e.prototype.removeListener=function(e){function n(t){if(i[t]){var n=i[t].indexOf(e);-1!=n&&i[t].splice(n,1),0==i[t].length&&delete i[t]}}if(e.horten&&e.horten!=this)throw"Trying to remove listener attached to different Horten instance";if(e._attachedToPath){var o=t(e._attachedToPath),i=this.getMeta(o,!1);i&&(n("lp"),n("lo")),delete e._attachedToPath}this._pendingListeners&&(this._pendingListeners=this._pendingListeners.filter(function(t){return t!=e}))},e.prototype.flush=function(){var e=this,n=this._pendingListeners;if(n&&n.length)for(var o=0;n.length>o;o++){var i=n[o],r=i._primitiveChanges,s=i._objectChange,a=i.onData,h=t(i.path),c=t(i.prefix);if(delete i._primitiveChanges,delete i._objectChange,"function"==typeof a){if(r)for(var l in r){var p=r[l],u=t(l).translate(h,c);p.deleted?(a.call(i,void 0,u,"delete",p.origin),void 0!==p.value&&a.call(i,p.value,u,"set",p.origin)):a.call(i,p.value,u,"set",p.origin)}s&&a.call(i,e.get(h),c,s.method,s.origin)}}delete this._pendingListeners},e.merge=function(n,o,i,r){function s(t,n){var o,i,s=t;if(Array.isArray(t))for(s={},i=0;t.length>i;i++)void 0!==t[i]&&(s[i+""]=!0);if(r&e.setFlags.replace)for(o in n)o in s||delete n[o];for(o in s)void 0===n[o]&&r&e.setFlags.keepTopology||a(o,t[o],n)}function a(t,n,o){var i=o[t],a=null!=i&&"object"==typeof i,h=null!=n&&"object"==typeof n;return h||i!==n?(a!=h||void 0===i)&&r&e.setFlags.keepTopology?!1:(h?(a||(o[t]=i={}),s(n,i)):o[t]=n,void 0):!1}i=t(i);var h,c,l=n,p=i.length;if("object"!=typeof n){if("/"==i)return o;typeof n!=typeof o&&(l=n={})}for(c=0;p-1>c;c++)if(h=i.getSegment(c),null==l[h]||"object"!=typeof l[h]){if(r&e.setFlags.keepTopology)return n;l=l[h]={}}else l=l[h];return 0==p?s(o,l,"/"):(h=i.getSegment(c),a(h,o,l,""+i)),n},e.walkObject=function(n,o,i){o=t(o);var r=o.array,s=r.length;if(null==n)return void 0;for(var a=0;s>a&&null!=n;a++)n=n[r[a]];return i||(n=e.clone(n)),n},e.clone=function(t){function e(t){var n,o,i={};for(var n in t)o=t[n],i[n]=null!==o&&"object"==typeof o?e(o):o;return i}return"object"==typeof t?e(t):t},e.flatten=function(e,n){function o(t,e){switch(typeof t){case"function":case"undefined":return;case"number":case"string":case"boolean":return i[e]=t,void 0}if(null===t)return i[e]=null,void 0;if(Array.isArray(t))for(var n=0;t.length>n;n++){var r=t[n];r!==void 0&&o(r,e+(n+"")+"/")}else for(var s in t)o(t[s],e+s+"/")}n=t(n);var i={};return o(e,n.string),i},e.Listener=n,n.prototype.attach=function(t){t&&(this.horten=t),this.horten||(this.horten=e.instance()),this.horten.attachListener(this)},n.prototype.remove=function(){this.horten&&this.horten.removeListener(this)},n.prototype.push=function(){if(this.primitive){var n,o=this.horten.get(this.path,!0);o=e.flatten(o);for(n in o)this.onData(o[n],t(n).translate(null,this.prefix))}else this.onData(this.horten.get(this.path),t(this.prefix),"push",this)},n.prototype.get=function(n){return(void 0==n||null==n)&&(n=this.prefix),n=t(n).translate(this.prefix,this.path),this.horten||(this.horten=e.instance()),n?this.horten.get(n):void 0},n.prototype.set=function(n,o,i){return(void 0==o||null==o)&&(o=this.prefix),o=t(o).translate(this.prefix,this.path),this.horten||(this.horten=e.instance()),o?this.horten.set(n,o,i,this):null},n.prototype.localToGlobalPath=function(e){return t(e).translate(this.prefix,this.path)},n.prototype.globalToLocalPath=function(e){return t(e).translate(this.path,this.prefix)},n.prototype.onData=function(t,e,n,o){"function"==typeof this.callback&&this.callback(t,e,n,o)},"function"==typeof require&&"object"==typeof exports){var a=require("websocket").client;exports.jsFile=__filename}return e.WebSocket=o,o.prototype=new n(null),o.connect=function(t){console.log("Trying connect with",t,WebSocket);var e;return"function"==typeof WebSocket&&t.WebSocket?(e=new i(t.WebSocket),e.attach()):"function"==typeof SockJS&&t.SockJS?(e=new r(t.SockJS,t.path),e.attach()):console.log("Nothing to connect with"),e},o.prototype.pull=function(e){e=t(e).string,this._pullPaths||(this._pullPaths=[]),-1==this._pullPaths.indexOf(e)&&this._pullPaths.push(e),this._pull()},o.prototype._pull=function(){if(this._pullPaths&&this._pullPaths.length&&this.readyToSend()){var t={get:this._pullPaths};this.send(t)&&(this._pullPaths=null)}},o.prototype.push=function(e){e=t(e),this._pushData||(this._pushData={}),this._pushData[e]=this.FILL_DATA,this._push()},o.prototype.readyToSend=function(){return!1},o.prototype.onremoteclose=function(){var t=this;this.keepAlive&&"function"==typeof this.reconnect?(console.log(t.name,"Remote closed, retrying in 1 second"),setTimeout(function(){t.reconnect()},1e3)):(console.log(t.name,"Closed by remote"),this.close())},o.prototype.onData=function(t,e){console.log("HWS ONDATA",t,e),this._pushData||(this._pushData={}),this._pushData[e]=t,this._push()},o.prototype.onRemoteData=function(t){if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return console.log(this.name,"Bad JSON from remote"),void 0}if(t.set){var n={};for(var o in t.set){var i=t.set[o];this.set(i,o)}console.log("GOT MESG set",n)}t.get&&this.push(t.get)},o.prototype.close=function(){this.remove(),this.keepAlive=!1,"function"==typeof this._close&&this._close()},o.prototype._push=function(){if(this._pushData&&this.readyToSend()){console.log("HWS PUSH",this._pushData);var t=!1;for(var e in this._pushData)t=!0,this._pushData[e]==this.FILL_DATA&&(this._pushData[e]=this.get(e));t&&this.send({set:this._pushData}),this._pushData={}}},o.prototype.attachWebSocket=function(t){var e=this;t.onopen=function(){console.log(e.name,"Open WS"),e._push(),e._pull()},t.onerror=function(t){console.log(e.name,"WS error "+JSON.stringify(t))},t.onmessage=function(t){e.onRemoteData(t.data)},t.onclose=function(){console.log(e.name,"onclose"),e.onremoteclose()},this.readyToSend=function(){return 1==t.readyState},this.send=function(e){return 1!=t.readyState?!1:(e=JSON.stringify(e),t.send(e),!0)},this._close=function(){t.close()},1==t.readyState&&(e._push(),e._pull())},o.prototype.attachWebSocketNodeClient=function(t){var e=this;t.on("connectFailed",function(){console.log(e.name,"Connecting failed"),e.onremoteclose()}),t.on("connect",function(t){console.log(e.name,"Connected "),e.wsn=t,t.on("close",function(){e.onremoteclose()}),t.on("message",function(t){return"utf8"!=t.type?(console.log(e.name,"Not UTF8 from remote"),void 0):(e.onRemoteData(t.utf8Data),void 0)}),e._push(),e._pull()}),this.readyToSend=function(){return e.wsn&&e.wsn.connected},this.send=function(t){return e.wsn&&e.wsn.connected?(e.wsn.sendUTF(JSON.stringify(t)),!0):!1}},i.prototype=new o(null),r.prototype=new o(null),e}();