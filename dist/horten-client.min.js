var urlParse=function(a,b){var c=/^((\w+:)\/)?\/?((.*?)@)?(([^:\/\s]+)(:(\d+))?)(([^?#]*)(\?([^#]*))?)(#.*)?/,d=c.exec(a),e={};if(e.protocol=d[2]||"",e.slashes=!0,e.auth=d[4]||null,e.host=d[5]||"",e.port=d[8]||null,e.hostname=d[6],e.hash=d[13]||null,e.search=d[11],b&&d[12]){var f=d[12].split("&");e.query={};for(var g=0;g<f.length;g++){var h=f[g].split("=");e.query[h[0]]=h[1]||""}}return e.pathname=d[10],e.path=d[9],e.href=a,e};H=Horten=function(){function a(b){if(b&&b.constructor==a)return b;if(this.constructor!=a)return new a(b);var c,d;b=null==b||void 0==b?"/":Array.isArray(b)?b.join("/"):String(b),d=b.split("/").filter(function(a){return"string"==typeof a&&a.length>0}),c=0==d.length?"/":"/"+d.join("/")+"/",this.string=c,this.array=d,this.length=d.length}function b(a){a&&"object"==typeof a||(a={}),a.debug&&(this.debug=!0),this.data={},this.meta={},b.__instance||(b.__instance=this)}function c(c,d){"string"==typeof c&&(c={path:c}),"object"==typeof c&&null!=c&&(this.path=new a(c.path),this.prefix=new a(c.prefix),this.primitive=!!c.primitive,this.horten=c.horten||b.instance(),c.debug&&(this.debug=!0),"function"==typeof d&&(this.onData=d),c.attach!==!1&&this.attach())}function d(a){a.primitive=!0,this.keepAlive=a.keepAlive,c.call(this,a)}function e(a,b,c){if(this instanceof e)throw new Error("Not a constructor");b||(b={}),b.keepAlive=b.keepAlive!==!1;var f;if("string"!=typeof a){if(Array.isArray(a)){var h,i;for(i=0;i<a.length&&!h;i++)if(h=e(a[i],b,c))return h;throw new Error("No compatible connect method")}throw new Error("parameter unsupported")}f=a,a=urlParse(a,!0),console.log("TRYING CONNNECT",a);var j;if("ws:"==a.protocol){j=new d(b),j.name=f;var h;if("function"==typeof require&&"undefined"!=typeof exports){var h;j.reconnect=function(){h=new(require("websocket").client),h.on("connectFailed",function(){console.log(j.name,"Connecting failed"),j.onRemoteClose()}),h.on("connect",function(a){console.log(j.name,"Connected "),j.wsn=a,a.on("close",function(){j.onRemoteClose()}),a.on("message",function(a){return"utf8"!=a.type?(console.log(j.name,"Not UTF8 from remote"),!1):(j.onRemoteData(a.utf8Data),void 0)}),j._push(),j._pull()}),h.connect(f,g)},j.readyToSend=function(){return j.wsn&&j.wsn.connected},j.send=function(a){return j.wsn&&j.wsn.connected?(j.wsn.sendUTF(JSON.stringify(a)),!0):!1}}else{if("function"!=typeof WebSocket&&"object"!=typeof WebSocket)return!1;j.reconnect=function(){console.log("WebSocket connecting to",a),h=new WebSocket(f,g),j.attachWebSocket(h)}}}else if("sockjs:"==a.protocol){if("function"!=typeof SockJS)return void 0;var k="http://"+a.hostname;a.port&&(k+=":"+a.port),k+=a.pathname,j=new d(b),j.name=f,j.reconnect=function(){console.log("SockJS Reconnect",k);var b=new SockJS(k);j.attachSockJSClient(b,a.query.path)}}return j&&j.reconnect?(j.pull(),j.reconnect(),j.attach(),j):void 0}b.Path=a,a.prototype.seg=function(a){return this.array[a]},a.prototype.set=function(a,c,d,e,f){return f=f||this.horten||b.instance(),void 0==c?f.set(a,this,d,e):(c=this.append(c),f.set(a,c,d,e))},a.prototype.get=function(a,c){return c=c||this.horten||b.instance(),void 0==a?c.get(this):(a=this.append(a),c.get(a))},a.prototype.append=function(b){return a(this.string+b)},a.prototype.translate=function(b,c){b=a(b);var d=b.string.length;return this.string.substr(0,d)!=b.string?void 0:(c=a(c),b.string==c.string?this:a(c.string+this.string.substr(d)))},a.prototype.is=function(b){return b=a(b),this==b},a.prototype.startsWith=function(b){b=a(b);var c=b.string.length;return this.string.substr(0,c)!=b.string?!1:a(this.string.substr(c))},a.prototype.toString=function(){return this.string};var f;f="object"==typeof process&&process.nextTick?process.nextTick:function(a){setTimeout(a,0)},b.Horten=b,b.instance=function(){return b.__instance||(b.__instance=new b),b.__instance},b.prototype.get=function(c,d){c=a(c);for(var e=this.data,f=c.array,g=f.length,h=0;g>h&&null!=e;h++)e=e[f[h]];return d||(e=b.clone(e)),e},b.setFlags={keepTopology:2,forceListeners:4,replace:8,readOnly:16},b.prototype.set=function(c,d,e,g){function h(a,c,d,f,g){var h,j,l=!1,m=a;if(Array.isArray(a))for(m={},j=0;j<a.length;j++)void 0!==a[j]&&(m[String(j)]=!0);if(e&b.setFlags.replace)for(h in c)h in m||(k(g,f+h+"/",void 0,!0),delete c[h]);for(h in m)void 0===c[h]&&e&b.setFlags.keepTopology||(l=i(h,a[h],c,d&&d._&&d._[h],f+h+"/",g)||l);return l}function i(a,c,d,f,i,l){var m=!1,o=d[a],p=null!=o&&"object"==typeof o,q=null!=c&&"object"==typeof c;return q||o!==c||e&b.setFlags.forceListeners?(p!=q||void 0===o)&&e&b.setFlags.keepTopology?!1:(f&&f.lp&&(l=l.concat(f.lp)),q?(p||(d[a]=o={}),m=h(c,o,f,i,l)||m):(p&&k(l,i,void 0,!0),d[a]=c,m=!0,n.debug&&console.log(g?g.name:"<anon>",i,JSON.stringify(c)),k(l,i,c)),m&&f&&f.lo&&j(f.lo),m):!1}function j(a){for(var b=0;b<a.length;b++){var c=a[b];c!==g&&(c._objectChange={origin:g,method:"set"},n._pendingListeners||(n._pendingListeners=[]),-1==n._pendingListeners.indexOf(c)&&n._pendingListeners.push(c))}}function k(a,b,c,d){for(var e=0;e<a.length;e++){var f=a[e];if(f!==g){f._primitiveChanges||(f._primitiveChanges={});var h={};h=f._primitiveChanges[b]?f._primitiveChanges[b]:f._primitiveChanges[b]={},h.origin=g,d?h.deleted=!0:h.value=c,n._pendingListeners||(n._pendingListeners=[]),-1==n._pendingListeners.indexOf(f)&&n._pendingListeners.push(f)}}}d=a(d),e=parseInt(e);var l,m,n=this,o=!1,p=this.data,q=this.meta,r=[],s=[],t=d.length;if("object"!=typeof c&&0==t)return!1;for(m=0;t-1>m;m++){l=d.seg(m);var u=p[l];if(null==u||"object"!=typeof u){if(e&b.setFlags.keepTopology)return!1;p=p[l]={},o=!0}else p=u;q&&(q.lp&&(r=r.concat(q.lp)),q.lo&&(s=s.concat(q.lo)),q=q._?q._[l]:null)}return q&&(q.lp&&(r=r.concat(q.lp)),q.lo&&(s=s.concat(q.lo))),0==t?o=h(c,p,q,"/",r)||o:(l=d.seg(m),q=q&&q._&&q._[l],o=i(l,c,p,q,d.toString(),r)||o),o&&(j(s),f(function(){n.flush()})),o},b.set=function(a,c,d,e){return b.instance().set(a,c,d,e)},b.get=function(a,c){return b.instance().get(a,c)},b.listen=function(a,c,d){return b.instance().listen(a,c,d)},b.listenPrimitive=function(a,c,d){return b.instance().listenPrimitive(a,c,d)},b.prototype.getMeta=function(b,c){b=a(b);for(var d,e=this.meta,f=0;d=b.seg(f);){if(!e._){if(!c)return void 0;e._={}}e._[d]||(e._[d]={}),e=e._[d],f++}return e},b.prototype.log=function(){var a=Array.prototype.slice.call(arguments);console.log(a.map(String).join("	"))},b.prototype.listen=function(b,d,e){e||(e={}),e.path=a(b);var f=new c(e);return f.callback=d,this.attachListener(f),f},b.prototype.listenPrimitive=function(b,d,e){e||(e={}),e.path=a(b),e.primitive=!0;var f=new c(e);return f.callback=d,this.attachListener(f),f},b.prototype.attachListener=function(b){b.horten&&b.horten!=this?b.horten.removeListener(b):this.removeListener(b);var c=a(b.path);b._attachedToPath=c,b.horten=this;var d=this.getMeta(c,!0),e=b.primitive?"lp":"lo";void 0==d[e]?d[e]=[b]:d[e].push(b)},b.prototype.removeListener=function(b){function c(a){if(e[a]){var c=e[a].indexOf(b);-1!=c&&e[a].splice(c,1),0==e[a].length&&delete e[a]}}if(b.horten&&b.horten!=this)throw"Trying to remove listener attached to different Horten instance";if(b._attachedToPath){var d=a(b._attachedToPath),e=this.getMeta(d,!1);e&&(c("lp"),c("lo")),delete b._attachedToPath}this._pendingListeners&&(this._pendingListeners=this._pendingListeners.filter(function(a){return a!=b}))},b.prototype.flush=function(){var b=this,c=this._pendingListeners;if(c&&c.length)for(var d=0;d<c.length;d++){var e=c[d],f=e._primitiveChanges,g=e._objectChange,h=e.onData,i=a(e.path),j=a(e.prefix);if(delete e._primitiveChanges,delete e._objectChange,"function"==typeof h){if(f)for(var k in f){var l=f[k],m=a(k).translate(i,j);l.deleted?(h.call(e,void 0,m,"delete",l.origin),void 0!==l.value&&h.call(e,l.value,m,"set",l.origin)):h.call(e,l.value,m,"set",l.origin)}g&&h.call(e,b.get(i),j,g.method,g.origin)}}delete this._pendingListeners},b.merge=function(c,d,e,f){function g(a,c){var d,e,g=a;if(Array.isArray(a))for(g={},e=0;e<a.length;e++)void 0!==a[e]&&(g[String(e)]=!0);if(f&b.setFlags.replace)for(d in c)d in g||delete c[d];for(d in g)void 0===c[d]&&f&b.setFlags.keepTopology||h(d,a[d],c)}function h(a,c,d){var e=d[a],h=null!=e&&"object"==typeof e,i=null!=c&&"object"==typeof c;return i||e!==c?(h!=i||void 0===e)&&f&b.setFlags.keepTopology?!1:(i?(h||(d[a]=e={}),g(c,e)):d[a]=c,void 0):!1}e=a(e);var i,j,k=c,l=e.length;if("object"!=typeof c){if("/"==e)return d;typeof c!=typeof d&&(k=c={})}for(j=0;l-1>j;j++)if(i=e.seg(j),null==k[i]||"object"!=typeof k[i]){if(f&b.setFlags.keepTopology)return c;k=k[i]={}}else k=k[i];return 0==l?g(d,k,"/"):(i=e.seg(j),h(i,d,k,e.toString())),c},b.walkObject=function(c,d,e){d=a(d);var f=d.array,g=f.length;if(null==c)return void 0;for(var h=0;g>h&&null!=c;h++)c=c[f[h]];return e||(c=b.clone(c)),c},b.clone=function(a){function b(a){var c,d,e={};for(var c in a)d=a[c],e[c]=null!==d&&"object"==typeof d?b(d):d;return e}return"object"==typeof a?b(a):a},b.flatten=function(b,c){function d(a,b){switch(typeof a){case"function":case"undefined":return;case"number":case"string":case"boolean":return e[b]=a,void 0}if(null===a)return e[b]=null,void 0;if(Array.isArray(a))for(var c=0;c<a.length;c++){var f=a[c];"undefined"!=typeof f&&d(f,b+String(c)+"/")}else for(var g in a)d(a[g],b+g+"/")}c=a(c);var e={};return d(b,c.string),e},b.Listener=c,c.prototype.attach=function(a){a&&(this.horten=a),this.horten||(this.horten=b.instance()),this.horten.attachListener(this)},c.prototype.remove=function(){this.horten&&this.horten.removeListener(this)},c.prototype.push=function(){if(this.primitive){var c,d=this.horten.get(this.path,!0);d=b.flatten(d);for(c in d)this.onData(d[c],a(c).translate(null,this.prefix))}else this.onData(this.horten.get(this.path),a(this.prefix),"push",this)},c.prototype.get=function(c){return(void 0==c||null==c)&&(c=this.prefix),c=a(c).translate(this.prefix,this.path),this.horten||(this.horten=b.instance()),c?this.horten.get(c):void 0},c.prototype.set=function(c,d,e){return(void 0==d||null==d||"/"==d||""==d)&&(d=this.prefix),d=a(d).translate(this.prefix,this.path),this.horten||(this.horten=b.instance()),d?this.horten.set(c,d,e,this):null},c.prototype.localToGlobalPath=function(b){return a(b).translate(this.prefix,this.path)},c.prototype.globalToLocalPath=function(b){return a(b).translate(this.path,this.prefix)},c.prototype.onData=function(a,b,c,d){"function"==typeof this.callback&&this.callback(a,b,c,d)},c.prototype.setPath=function(b){var c=!!this._attachedToPath;this.remove(),this.path=a(b),c&&this.attach()},d.prototype=new c(null),d.prototype.pull=function(b){b=a(b).string,this._pullPaths||(this._pullPaths=[]),-1==this._pullPaths.indexOf(b)&&this._pullPaths.push(b),this._pull()},d.prototype._pull=function(){if(this._pullPaths&&this._pullPaths.length&&this.readyToSend()){var a={get:this._pullPaths};this.send(a)&&(this._pullPaths=null)}},d.prototype.push=function(b){b=a(b),this._pushData||(this._pushData={}),this._pushData[b]=this.FILL_DATA,this._push()},d.prototype._push=function(){if(this._pushData&&this.readyToSend()){var a=!1;for(var b in this._pushData)a=!0,this._pushData[b]==this.FILL_DATA&&(this._pushData[b]=this.get(b));a&&this.send({set:this._pushData}),this._pushData={}}},d.prototype.readyToSend=function(){return!1},d.prototype.onRemoteClose=function(){var a=this;this.keepAlive&&"function"==typeof this.reconnect?(console.log(a.name,"Remote closed, retrying in 1 second"),setTimeout(function(){a.reconnect()},1e3)):(console.log(a.name,"Closed by remote"),this.close())},d.prototype.onData=function(a,b){this._pushData||(this._pushData={}),this._pushData[b]=a,this._push()},d.prototype.onRemoteData=function(a){if(this.debug&&console.log(this.name,"RECV",a),"string"==typeof a)try{a=JSON.parse(a)}catch(b){return console.log(this.name,"Bad JSON from remote"),void 0}if(a.set)for(var c in a.set){var d=a.set[c];this.set(d,c)}a.get&&this.push(a.get)},d.prototype.close=function(){this.remove(),this.keepAlive=!1,"function"==typeof this._close&&this._close()},d.prototype.attachWebSocket=function(a){var b=this;a.onopen=function(){console.log(b.name,"Open WS"),b._push(),b._pull()},a.onerror=function(a){console.log(b.name,"WS error "+JSON.stringify(a))},a.onmessage=function(a){b.onRemoteData(a.data)},a.onclose=function(){b.onRemoteClose()},this.readyToSend=function(){return 1==a.readyState},this.send=function(b){return 1!=a.readyState?!1:(b=JSON.stringify(b),a.send(b),!0)},this._close=function(){a.close()},1==a.readyState&&(b._push(),b._pull())},d.prototype.attachSockJSClient=function(b,c){that=this,that.sockJS=b,c=a(c).string,b.onopen=function(){b.send(JSON.stringify({path:c}))},b.onmessage=function(a){try{a=JSON.parse(a.data)}catch(c){return console.log(that.name,"Bad JSON in server path response",a),b.close(),that.onRemoteClose(),void 0}a?(that.attachWebSocket(b),that.onRemoteData(a)):(console.log(that.name,"Didn't get path handshake from server"),b.close(),that.onRemoteClose())},b.onclose=function(){console.log(that.name,"Didn't get path handshake from server"),that.onRemoteClose()},b.onerror=function(){}},b.Client=e;var g="horten-protocol";return b}();