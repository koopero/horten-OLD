var H=function(a){function b(a,b){var c=/^((\w+:)\/)?\/?((.*?)@)?(([^:\/\s]+)(:(\d+))?)(([^?#]*)(\?([^#]*))?)(#.*)?/,d=c.exec(a),e={};if(e.protocol=d[2]||"",e.slashes=!0,e.auth=d[4]||null,e.host=d[5]||"",e.port=d[8]||null,e.hostname=d[6],e.hash=d[13]||null,e.search=d[11],b&&d[12]){var f=d[12].split("&");e.query={};for(var g=0;g<f.length;g++){var h=f[g].split("=");e.query[h[0]]=h[1]||""}}return e.pathname=d[10],e.path=d[9],e.href=a,e}function c(){return f.instance()}function d(a){setTimeout(a,1)}function e(a){function b(a){if(null!==a){var e=typeof a;if("object"==e)for(var f=0;void 0!==a[f];)b(a[f]),f++;else"number"==e||"boolean"==e?d(String(a)):"string"==e&&c(a)}}function c(a){for(var b,c=0,e=a.length;e>c;)"/"!=a[c]?(b=a.indexOf("/",c),-1==b&&(b=a.length),d(a.substr(c,b-c)),c=b+1):c++}function d(a){f[f.length]=a,f.length++,f.string+=a+"/"}if(a&&1==arguments.length&&a.constructor==e)return a;if(this.constructor!=e)return new e(a);var f=this;return f.string="/",f.length=0,b(arguments),f}function f(b){var c=this;return c.constructor!=f?f.instance():(b&&"object"==typeof b||(b={}),b.debug&&(c.debug=!0),c.data={},c.meta={},void(a.__HortenInstance||(a.__HortenInstance=c)))}function g(a,b){var d=this;"string"==typeof a&&(a={path:a}),"object"==typeof a&&null!=a&&(d.path=e(a.path),d.prefix=e(a.prefix),d.primitive=!!a.primitive,a.debug&&(d.debug=!0),"function"==typeof b&&(d.onData=b),a.attach!==!1&&(d.horten=a.horten||c(),d.attach()))}function h(a){a.primitive=!0,this.keepAlive=a.keepAlive,g.call(this,a)}function i(a,c,d){if(this instanceof i)throw new Error("Not a constructor");c||(c={}),c.keepAlive=c.keepAlive!==!1;var e;if("string"!=typeof a){if(Array.isArray(a)){var f,g;for(g=0;g<a.length&&!f;g++)if(f=i(a[g],c,d))return f;throw new Error("No compatible connect method")}throw new Error("parameter unsupported")}e=a,a=b(a,!0),console.log("TRYING CONNNECT",a);var j;if("ws:"==a.protocol){j=new h(c),j.name=e;var f;if("function"!=typeof WebSocket&&"object"!=typeof WebSocket)return!1;j.reconnect=function(){console.log("WebSocket connecting to",a),f=new WebSocket(e,k),j.attachWebSocket(f)}}else if("sockjs:"==a.protocol){if("function"!=typeof SockJS)return void 0;var l="http://"+a.hostname;a.port&&(l+=":"+a.port),l+=a.pathname,j=new h(c),j.name=e,j.reconnect=function(){console.log("SockJS Reconnect",l);var b=new SockJS(l);j.attachSockJSClient(b,a.query.path)}}return j&&j.reconnect?(j.pull(),j.reconnect(),j.attach(),j):void 0}var j=function(a,b){a.super_=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})};e.prototype.seg=function(a){return this.array[a]},e.prototype.set=function(a,b,d,e,f){return f=f||this.horten||c(),void 0==b?f.set(a,this,d,e):(b=this.append(b),f.set(a,b,d,e))},e.prototype.get=function(a,b){return b=b||this.horten||c(),void 0==a?b.get(this):(a=this.append(a),b.get(a))},e.prototype.append=function(a){return e(this.string+a)},e.prototype.slice=function(a,b){var c=this,d=new e;for(a=parseInt(a),b=parseInt(b),void 0===b&&(b=c.length);a<c.length&&b;)d[d.length]=c[a],d.length++,d.str+=str+"/",a++,b--},e.prototype.translate=function(a,b){a=e(a);var c=a.string.length;return this.string.substr(0,c)!=a.string?void 0:(b=e(b),a.string==b.string?this:e(b.string+this.string.substr(c)))},e.prototype.is=function(a){return a=e(a),this==a},e.prototype.startsWith=function(a){a=e(a);var b=a.string.length;return this.string.substr(0,b)!=a.string?!1:e(this.string.substr(b))},e.prototype.toString=function(){return this.string},f.instance=function(){return a.__HortenInstance||(a.__HortenInstance=new f),a.__HortenInstance},f.prototype.get=function(a,b){a=e(a);for(var c=this.data,d=a.length,g=0;d>g&&null!=c;g++)c=c[a[g]];return b||(c=f.clone(c)),c},f.setFlags={keepTopology:2,forceListeners:4,replace:8,readOnly:16},f.prototype.set=function(a,b,c,g){function h(a,b,d,e,g){var h,j,l=!1,m=a;if(Array.isArray(a))for(m={},j=0;j<a.length;j++)void 0!==a[j]&&(m[String(j)]=!0);if(c&f.setFlags.replace)for(h in b)h in m||(k(g,e+h+"/",void 0,!0),delete b[h]);for(h in m)void 0===b[h]&&c&f.setFlags.keepTopology||(l=i(h,a[h],b,d&&d._&&d._[h],e+h+"/",g)||l);return l}function i(a,b,d,e,i,l){var m=!1,o=d[a],p=null!=o&&"object"==typeof o,q=null!=b&&"object"==typeof b;return q||o!==b||c&f.setFlags.forceListeners?(p!=q||void 0===o)&&c&f.setFlags.keepTopology?!1:(e&&e.lp&&(l=l.concat(e.lp)),q?(p||(d[a]=o={}),m=h(b,o,e,i,l)||m):(p&&k(l,i,void 0,!0),d[a]=b,m=!0,n.debug&&console.log(g?g.name:"<anon>",i,JSON.stringify(b)),k(l,i,b)),m&&e&&e.lo&&j(e.lo),m):!1}function j(a){for(var b=0;b<a.length;b++){var c=a[b];c!==g&&(c._objectChange={origin:g,method:"set"},n._pendingListeners||(n._pendingListeners=[]),-1==n._pendingListeners.indexOf(c)&&n._pendingListeners.push(c))}}function k(a,b,c,d){for(var e=0;e<a.length;e++){var f=a[e];if(f!==g){f._primitiveChanges||(f._primitiveChanges={});var h={};h=f._primitiveChanges[b]?f._primitiveChanges[b]:f._primitiveChanges[b]={},h.origin=g,d?h.deleted=!0:h.value=c,n._pendingListeners||(n._pendingListeners=[]),-1==n._pendingListeners.indexOf(f)&&n._pendingListeners.push(f)}}}b=e(b),c=parseInt(c);var l,m,n=this,o=!1,p=this.data,q=this.meta,r=[],s=[],t=b.length;if("object"!=typeof a&&0==t)return!1;for(m=0;t-1>m;m++){l=b[m];var u=p[l];if(null==u||"object"!=typeof u){if(c&f.setFlags.keepTopology)return!1;p=p[l]={},o=!0}else p=u;q&&(q.lp&&(r=r.concat(q.lp)),q.lo&&(s=s.concat(q.lo)),q=q._?q._[l]:null)}return q&&(q.lp&&(r=r.concat(q.lp)),q.lo&&(s=s.concat(q.lo))),0==t?o=h(a,p,q,"/",r)||o:(l=b[m],q=q&&q._&&q._[l],o=i(l,a,p,q,b.toString(),r)||o),o&&(j(s),d(function(){n.flush()})),o},f.set=function(a,b,c,d){return f.instance().set(a,b,c,d)},f.get=function(a,b){return f.instance().get(a,b)},f.listen=function(a,b,c){return f.instance().listen(a,b,c)},f.listenPrimitive=function(a,b,c){return f.instance().listenPrimitive(a,b,c)},f.prototype.getMeta=function(a,b){a=e(a);for(var c,d=this.meta,f=0;c=a[f];){if(!d._){if(!b)return void 0;d._={}}d._[c]||(d._[c]={}),d=d._[c],f++}return d},f.prototype.log=function(){var a=Array.prototype.slice.call(arguments);console.log(a.map(String).join("	"))},f.prototype.listen=function(a,b,c){c||(c={}),c.path=e(a);var d=new g(c);return d.callback=b,this.attachListener(d),d},f.prototype.listenPrimitive=function(a,b,c){c||(c={}),c.path=e(a),c.primitive=!0;var d=new g(c);return d.callback=b,this.attachListener(d),d},f.prototype.attachListener=function(a){a.horten&&a.horten!=this?a.horten.removeListener(a):this.removeListener(a);var b=e(a.path);a._attachedToPath=b,a.horten=this;var c=this.getMeta(b,!0),d=a.primitive?"lp":"lo";void 0==c[d]?c[d]=[a]:c[d].push(a)},f.prototype.removeListener=function(a){function b(b){if(d[b]){var c=d[b].indexOf(a);-1!=c&&d[b].splice(c,1),0==d[b].length&&delete d[b]}}if(a.horten&&a.horten!=this)throw"Trying to remove listener attached to different Horten instance";if(a._attachedToPath){var c=e(a._attachedToPath),d=this.getMeta(c,!1);d&&(b("lp"),b("lo")),delete a._attachedToPath}this._pendingListeners&&(this._pendingListeners=this._pendingListeners.filter(function(b){return b!=a}))},f.prototype.flush=function(){var a=this,b=this._pendingListeners;if(b&&b.length)for(var c=0;c<b.length;c++){var d=b[c],f=d._primitiveChanges,g=d._objectChange,h=d.onData,i=e(d.path),j=e(d.prefix);if(delete d._primitiveChanges,delete d._objectChange,"function"==typeof h){if(f)for(var k in f){var l=f[k],m=e(k).translate(i,j);l.deleted?(h.call(d,void 0,m,"delete",l.origin),void 0!==l.value&&h.call(d,l.value,m,"set",l.origin)):h.call(d,l.value,m,"set",l.origin)}g&&h.call(d,a.get(i),j,g.method,g.origin)}}delete this._pendingListeners},f.merge=function(a,b,c,d){function g(a,b){var c,e,g=a;if(Array.isArray(a))for(g={},e=0;e<a.length;e++)void 0!==a[e]&&(g[String(e)]=!0);if(d&f.setFlags.replace)for(c in b)c in g||delete b[c];for(c in g)void 0===b[c]&&d&f.setFlags.keepTopology||h(c,a[c],b)}function h(a,b,c){var e=c[a],h=null!=e&&"object"==typeof e,i=null!=b&&"object"==typeof b;return i||e!==b?(h!=i||void 0===e)&&d&f.setFlags.keepTopology?!1:void(i?(h||(c[a]=e={}),g(b,e)):c[a]=b):!1}c=e(c);var i,j,k=a,l=c.length;if("object"!=typeof a){if(!c.length)return b;typeof a!=typeof b&&(k=a={})}for(j=0;l-1>j;j++)if(i=c[j],null==k[i]||"object"!=typeof k[i]){if(d&f.setFlags.keepTopology)return a;k=k[i]={}}else k=k[i];return 0==l?g(b,k,"/"):(i=c[j],h(i,b,k,c.toString())),a},f.walk=function(a,b,c){b=e(b);var d=b.length;if(null==a)return void 0;for(var g=0;d>g&&null!=a;g++)a=a[b[g]];return c||(a=f.clone(a)),a},f.clone=function(a){function b(a){var c,d,e={};for(var c in a)d=a[c],e[c]=null!==d&&"object"==typeof d?b(d):d;return e}return"object"==typeof a?b(a):a},f.flatten=function(a,b){function c(a,b){switch(typeof a){case"function":case"undefined":return;case"number":case"string":case"boolean":return void(d[b]=a)}if(null===a)return void(d[b]=null);if(Array.isArray(a))for(var e=0;e<a.length;e++){var f=a[e];"undefined"!=typeof f&&c(f,b+String(e)+"/")}else for(var g in a)c(a[g],b+g+"/")}b=e(b);var d={};return c(a,b.string),d},g.prototype.attach=function(a){var b=this;a&&(b.horten=a),b.horten||(b.horten=c()),b.horten.attachListener(b)},g.prototype.remove=function(){var a=this;a.horten&&a.horten.removeListener(a)},g.prototype.push=function(){var a=this,b=a.horten||c();if(a.primitive){var d,f=b.get(a.path,!0);f=flatten(f);for(d in f)a.onData(f[d],e(d).translate(null,a.prefix))}else a.onData(b.get(a.path),e(a.prefix),"push",a)},g.prototype.get=function(a){return(void 0==a||null==a)&&(a=this.prefix),a=e(a).translate(this.prefix,this.path),this.horten||(this.horten=c()),a?this.horten.get(a):void 0},g.prototype.set=function(a,b,d){return(void 0==b||null==b||"/"==b||""==b)&&(b=this.prefix),b=e(b).translate(this.prefix,this.path),this.horten||(this.horten=c()),b?this.horten.set(a,b,d,this):null},g.prototype.localToGlobalPath=function(a){return e(a).translate(this.prefix,this.path)},g.prototype.globalToLocalPath=function(a){return e(a).translate(this.path,this.prefix)},g.prototype.onData=function(a,b,c,d){"function"==typeof this.callback&&this.callback(a,b,c,d)},g.prototype.setPath=function(a){var b=!!this._attachedToPath;this.remove(),this.path=e(a),b&&this.attach()},j(h,g),h.prototype.pull=function(a){var b=this;a=e(a).string,b._pullPaths||(b._pullPaths=[]),-1==b._pullPaths.indexOf(a)&&b._pullPaths.push(a),b._pull()},h.prototype._pull=function(){var a=this;if(a._pullPaths&&a._pullPaths.length&&a.readyToSend()){var b={get:a._pullPaths};a.send(b)&&(a._pullPaths=null)}},h.prototype.push=function(a){var b=this;a=e(a),b._pushData||(b._pushData={}),b._pushData[a]=b.FILL_DATA,b._push()},h.prototype._push=function(){var a=this;if(a._pushData&&a.readyToSend()){var b=!1;for(var c in a._pushData)b=!0,a._pushData[c]==a.FILL_DATA&&(a._pushData[c]=a.get(c));b&&a.send({set:a._pushData}),a._pushData={}}},h.prototype.readyToSend=function(){return!1},h.prototype.onRemoteClose=function(){var a=this;a.keepAlive&&"function"==typeof a.reconnect?(console.log(a.name,"Remote closed, retrying in 1 second"),setTimeout(function(){a.reconnect()},1e3)):(console.log(a.name,"Closed by remote"),a.close())},h.prototype.onData=function(a,b){var c=this;c._pushData||(c._pushData={}),c._pushData[b]=a,c._push()},h.prototype.onRemoteData=function(a){if(this.debug&&console.log(this.name,"RECV",a),"string"==typeof a)try{a=JSON.parse(a)}catch(b){return void console.log(this.name,"Bad JSON from remote")}if(a.set){for(var c in a.set){var d=a.set[c];this.set(d,c)}}a.get&&this.push(a.get)},h.prototype.close=function(){this.remove(),this.keepAlive=!1,"function"==typeof this._close&&this._close()},h.prototype.attachWebSocket=function(a){var b=this;a.onopen=function(){console.log(b.name,"Open WS"),b._push(),b._pull()},a.onerror=function(a){console.log(b.name,"WS error "+JSON.stringify(a))},a.onmessage=function(a){b.onRemoteData(a.data)},a.onclose=function(){b.onRemoteClose()},this.readyToSend=function(){return 1==a.readyState},this.send=function(b){return 1!=a.readyState?!1:(b=JSON.stringify(b),a.send(b),!0)},this._close=function(){a.close()},1==a.readyState&&(b._push(),b._pull())},h.prototype.attachSockJSClient=function(a,b){var c=this;c.sockJS=a,b=e(b).string,a.onopen=function(){a.send(JSON.stringify({path:b}))},a.onmessage=function(b){try{b=JSON.parse(b.data)}catch(d){return console.log(c.name,"Bad JSON in server path response",b),a.close(),void c.onRemoteClose()}b?(c.attachWebSocket(a),c.onRemoteData(b)):(console.log(c.name,"Didn't get path handshake from server"),a.close(),c.onRemoteClose())},a.onclose=function(){console.log(c.name,"Didn't get path handshake from server"),c.onRemoteClose()},a.onerror=function(){}};var k="horten-protocol";return f.Listener=g,f.Client=i,f.Path=e,f}(window);